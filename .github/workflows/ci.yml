name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.9"

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.9", "3.10", "3.11", "3.12"]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev
          # Install virtual display for headless testing
          sudo apt-get install -y xvfb

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -e ".[dev]"

      - name: Run linting
        run: |
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      - name: Run type checking
        run: |
          mypy src/paprwall --ignore-missing-imports

      - name: Run tests (Linux)
        if: runner.os == 'Linux'
        run: |
          # Run tests with virtual display
          xvfb-run -a python -m pytest tests/ -v --cov=paprwall --cov-report=xml

      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        run: |
          python -m pytest tests/ -v --cov=paprwall --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: ${{ runner.os }}-${{ matrix.python-version }}
          name: codecov-umbrella
          fail_ci_if_error: false

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run bandit security scan
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ || true

      - name: Check for known vulnerabilities
        run: |
          safety check --json --output safety-report.json || true
          safety check || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'release' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev
          sudo apt-get install -y dpkg-dev rpm build-essential

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller>=5.0
          pip install -r requirements.txt
          pip install -e .

      - name: Build Linux executable
        run: |
          chmod +x scripts/build_linux.sh
          ./scripts/build_linux.sh

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            paprwall-v*-linux-*.tar.gz
            paprwall-v*-linux-*.tar.gz.sha256
            paprwall_*_amd64.deb
            paprwall-*-1.x86_64.rpm
            dist/paprwall-gui
            release-v*/

  build-appimage:
    name: Build AppImage (Universal Linux)
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'release' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev fuse libfuse2

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller>=5.0
          pip install -r requirements.txt
          pip install -e .

      - name: Build AppImage
        run: |
          chmod +x scripts/build_appimage.sh
          ./scripts/build_appimage.sh

      - name: Upload AppImage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: appimage-build
          path: |
            PaprWall-*-x86_64.AppImage
            PaprWall-*-x86_64.AppImage.sha256
            release-appimage-v*/

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: [test]
    if: github.event_name == 'release' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller>=5.0
          pip install -r requirements.txt
          pip install -e .

      - name: Build Windows executable
        shell: cmd
        run: scripts\build_windows.bat

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            paprwall-v*-windows-*.zip
            paprwall-v*-windows-*.zip.sha256
            dist/paprwall-gui.exe
            release-v*/

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: [test]
    if: github.event_name == 'release' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller>=5.0
          pip install -r requirements.txt
          pip install -e .

      - name: Build macOS executable
        run: |
          # Get version
          VERSION=$(python -c "import sys; sys.path.insert(0, 'src'); from paprwall.__version__ import __version__; print(__version__)")

          # Build with PyInstaller
          pyinstaller --onefile \
            --name paprwall-gui \
            --windowed \
            --osx-bundle-identifier com.riturajprofile.paprwall \
            --add-data "README.md:." \
            --add-data "LICENSE:." \
            --hidden-import PIL \
            --hidden-import PIL.Image \
            --hidden-import PIL.ImageDraw \
            --hidden-import PIL.ImageFont \
            --hidden-import PIL.ImageTk \
            --hidden-import requests \
            --hidden-import tkinter \
            --hidden-import paprwall \
            --hidden-import paprwall.core \
            --hidden-import paprwall.gui \
            --hidden-import paprwall.cli \
            --hidden-import paprwall.installer \
            src/paprwall/gui/wallpaper_manager_gui.py

          # Create release directory
          RELEASE_DIR="release-v$VERSION-macos"
          mkdir -p "$RELEASE_DIR"
          cp dist/paprwall-gui "$RELEASE_DIR/"
          [ -f README.md ] && cp README.md "$RELEASE_DIR/"
          [ -f LICENSE ] && cp LICENSE "$RELEASE_DIR/"

          # Create archive
          tar -czf "paprwall-v$VERSION-macos-x64.tar.gz" "$RELEASE_DIR"
          shasum -a 256 "paprwall-v$VERSION-macos-x64.tar.gz" > "paprwall-v$VERSION-macos-x64.tar.gz.sha256"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            paprwall-v*-macos-*.tar.gz
            paprwall-v*-macos-*.tar.gz.sha256
            dist/paprwall-gui
            release-v*-macos/

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'release'
    environment: pypi

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install build twine

      - name: Build distribution packages
        run: |
          python -m build

      - name: Check distribution packages
        run: |
          twine check dist/*

      - name: Publish to Test PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          twine upload --repository testpypi dist/* || echo "Test PyPI upload failed, continuing..."

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          twine upload dist/*

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      [build-linux, build-appimage, build-windows, build-macos, publish-pypi]
    if: github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(python -c "import sys; sys.path.insert(0, 'src'); from paprwall.__version__ import __version__; print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create release notes
        run: |
          cat > release_notes.md << EOF
          # PaprWall v${{ steps.version.outputs.version }}

          ## ðŸŽ¨ Modern Desktop Wallpaper Manager with Motivational Quotes

          ### ðŸ“¥ Installation Options

          #### ðŸ§ Linux
          - **Debian/Ubuntu**: Download \`paprwall_${{ steps.version.outputs.version }}_amd64.deb\`
          - **Fedora/RHEL**: Download \`paprwall-${{ steps.version.outputs.version }}-1.x86_64.rpm\`
          - **Portable**: Download \`paprwall-v${{ steps.version.outputs.version }}-linux-x86_64.tar.gz\`
          - **PyPI**: \`pip install paprwall\`

          #### ðŸªŸ Windows
          - **Portable**: Download \`paprwall-v${{ steps.version.outputs.version }}-windows-x64.zip\`
          - **PyPI**: \`pip install paprwall\`

          #### ðŸŽ macOS
          - **Portable**: Download \`paprwall-v${{ steps.version.outputs.version }}-macos-x64.tar.gz\`
          - **PyPI**: \`pip install paprwall\`

          ### ðŸ“‹ System Requirements
          - **Linux**: Ubuntu 20.04+, Fedora 35+, or equivalent
          - **Windows**: Windows 10 (1809+) or Windows 11
          - **macOS**: macOS 10.14+ (not fully tested)
          - **Display**: 720p or higher recommended
          - **Python**: 3.8+ (only for pip installation)

          ### âœ¨ Features
          - ðŸŽ¨ Modern GUI with large 480px preview panel
          - ðŸ’­ 6 quote categories (Motivational, Math, Science, Famous, Tech, Philosophy)
          - ðŸ”„ Auto-rotation with customizable intervals
          - ðŸ“œ History gallery with thumbnails
          - ðŸ–¥ï¸ Multi-desktop environment support
          - ðŸŒ Web-inspired dark theme interface

          ### ðŸš€ Quick Start
          \`\`\`bash
          # Linux: Extract and run
          tar -xzf paprwall-v${{ steps.version.outputs.version }}-linux-x86_64.tar.gz
          cd release-v${{ steps.version.outputs.version }}
          ./paprwall-gui

          # Windows: Extract and run
          # Extract paprwall-v${{ steps.version.outputs.version }}-windows-x64.zip
          # Run paprwall-gui.exe

          # PyPI installation (all platforms)
          pip install paprwall
          paprwall-gui
          \`\`\`

          ### ðŸ“Š Checksums (SHA-256)
          Verify your downloads:
          \`\`\`bash
          sha256sum -c *.sha256
          \`\`\`

          ---
          **Full Documentation**: [README.md](https://github.com/riturajprofile/paprwall/blob/main/README.md)
          **Issues & Support**: [GitHub Issues](https://github.com/riturajprofile/paprwall/issues)
          EOF

      - name: Update release with artifacts
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: |
            linux-build/paprwall-v*-linux-*.tar.gz
            linux-build/paprwall-v*-linux-*.tar.gz.sha256
            linux-build/paprwall_*_amd64.deb
            linux-build/paprwall-*-1.x86_64.rpm
            appimage-build/PaprWall-*-x86_64.AppImage
            appimage-build/PaprWall-*-x86_64.AppImage.sha256
            windows-build/paprwall-v*-windows-*.zip
            windows-build/paprwall-v*-windows-*.zip.sha256
            macos-build/paprwall-v*-macos-*.tar.gz
            macos-build/paprwall-v*-macos-*.tar.gz.sha256
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false

  notify:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always() && github.event_name == 'release'

    steps:
      - name: Success notification
        if: needs.create-release.result == 'success'
        run: |
          echo "ðŸŽ‰ Release completed successfully!"
          echo "âœ… All builds completed"
          echo "âœ… Packages uploaded to PyPI"
          echo "âœ… GitHub release created"
          echo "âœ… All artifacts attached"

      - name: Failure notification
        if: needs.create-release.result == 'failure'
        run: |
          echo "âŒ Release failed!"
          echo "Check the logs above for details"
          exit 1
