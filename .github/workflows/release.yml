name: Automated Release

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "pyproject.toml"
      - "requirements.txt"
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: "Create pre-release"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

env:
  PYTHON_VERSION: "3.9"

jobs:
  check-version:
    name: Check Version Changes
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.changed }}
      current_version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.decide.outputs.release }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Get current version
        id: version
        run: |
          VERSION=$(python -c "import sys; sys.path.insert(0, 'src'); from paprwall.__version__ import __version__; print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Check if version changed
        id: check
        run: |
          # Get the version from the previous commit
          git checkout HEAD~1 2>/dev/null || echo "No previous commit"
          PREV_VERSION=""
          if [ -f "src/paprwall/__version__.py" ]; then
            PREV_VERSION=$(python -c "import sys; sys.path.insert(0, 'src'); from paprwall.__version__ import __version__; print(__version__)" 2>/dev/null || echo "")
          fi
          git checkout HEAD

          echo "Previous version: $PREV_VERSION"
          echo "Current version: ${{ steps.version.outputs.version }}"

          if [ "$PREV_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Version has changed!"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged"
          fi

      - name: Decide whether to release
        id: decide
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "release=true" >> $GITHUB_OUTPUT
            echo "Manual release triggered"
          elif [[ "${{ steps.check.outputs.changed }}" == "true" ]]; then
            echo "release=true" >> $GITHUB_OUTPUT
            echo "Version changed, will create release"
          else
            echo "release=false" >> $GITHUB_OUTPUT
            echo "No release needed"
          fi

  create-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    outputs:
      tag_name: ${{ steps.tag.outputs.tag }}
      release_notes: ${{ steps.notes.outputs.notes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Create tag
        id: tag
        run: |
          VERSION="${{ needs.check-version.outputs.current_version }}"
          TAG_NAME="v$VERSION"

          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists"
            echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          else
            # Create and push tag
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
            git push origin "$TAG_NAME"
            echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "Created tag: $TAG_NAME"
          fi

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.check-version.outputs.current_version }}"
          TAG_NAME="v$VERSION"

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          echo "Generating release notes for $TAG_NAME (previous: $PREV_TAG)"

          # Create release notes
          cat > release_notes.md << EOF
          # üé® PaprWall v$VERSION - Modern Desktop Wallpaper Manager

          ## What's New

          This release includes improvements and bug fixes to make your wallpaper experience even better!

          ## üì• Quick Installation

          ### üêß Linux
          \`\`\`bash
          # Download and extract
          wget https://github.com/riturajprofile/paprwall/releases/download/$TAG_NAME/paprwall-v$VERSION-linux-x86_64.tar.gz
          tar -xzf paprwall-v$VERSION-linux-x86_64.tar.gz
          cd release-v$VERSION
          ./paprwall-gui
          \`\`\`

          ### ü™ü Windows
          \`\`\`cmd
          :: Download paprwall-v$VERSION-windows-x64.zip
          :: Extract and run paprwall-gui.exe
          \`\`\`

          ### üì¶ PyPI (All Platforms)
          \`\`\`bash
          pip install paprwall
          paprwall-gui
          \`\`\`

          ## üîÑ Changes in this Release

          EOF

          # Add commit messages since last tag
          if [ -n "$PREV_TAG" ]; then
            echo "### Commits since $PREV_TAG:" >> release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> release_notes.md
          else
            echo "### All commits in this release:" >> release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%h)" >> release_notes.md
          fi

          cat >> release_notes.md << EOF

          ## üõ†Ô∏è Technical Details

          - **Version**: $VERSION
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit**: $(git rev-parse --short HEAD)
          - **Python**: 3.8+

          ## üìã Supported Platforms

          | Platform | Architecture | Package Type | Status |
          |----------|-------------|--------------|---------|
          | Linux | x86_64 | .tar.gz, .deb, .rpm | ‚úÖ Supported |
          | Windows | x64 | .zip, .exe | ‚úÖ Supported |
          | macOS | x64 | .tar.gz | ‚ö†Ô∏è Experimental |

          ## üéØ System Requirements

          - **Linux**: Ubuntu 20.04+, Fedora 35+, or equivalent
          - **Windows**: Windows 10 (1809+) or Windows 11
          - **Display**: 720p or higher recommended
          - **Memory**: 256MB RAM minimum
          - **Storage**: 50MB free space
          - **Network**: Internet connection for wallpaper downloads

          ## ‚ú® Features Included

          - üé® **Modern GUI** - Full-screen responsive design with 480px preview
          - üí≠ **Smart Quotes** - 6 categories: Motivational, Math, Science, Famous, Tech, Philosophy
          - üîÑ **Auto-Rotation** - Customizable intervals with countdown timer
          - üìú **History Gallery** - Browse recent wallpapers with thumbnails
          - üñ•Ô∏è **Multi-Desktop** - GNOME, KDE, XFCE, MATE, Cinnamon, LXQt support
          - üåê **Web APIs** - Quotable.io & ZenQuotes.io integration
          - üìÅ **Local Files** - Use your own images with quote overlays

          ## üîí Security & Verification

          All release assets include SHA-256 checksums for verification:

          \`\`\`bash
          # Verify downloads
          sha256sum -c *.sha256
          \`\`\`

          ## üÜò Support & Issues

          - **Documentation**: [README.md](https://github.com/riturajprofile/paprwall#readme)
          - **Issues**: [GitHub Issues](https://github.com/riturajprofile/paprwall/issues)
          - **Discussions**: [GitHub Discussions](https://github.com/riturajprofile/paprwall/discussions)

          ---

          **‚≠ê Like PaprWall?** Give us a star on GitHub and share with your friends!

          **üêõ Found a bug?** Please [report it](https://github.com/riturajprofile/paprwall/issues/new) so we can fix it.

          **üí° Have an idea?** Start a [discussion](https://github.com/riturajprofile/paprwall/discussions) and let's make it happen!
          EOF

          # Output the notes
          {
            echo 'notes<<EOF'
            cat release_notes.md
            echo EOF
          } >> $GITHUB_OUTPUT

  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    needs: [check-version, create-tag]
    if: needs.check-version.outputs.should_release == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger build workflow
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;

            // Trigger the main CI workflow which handles building and releasing
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: 'ci.yml',
              ref: 'main'
            });

            console.log('Triggered CI workflow for building and releasing');

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-tag.outputs.tag_name }}
          name: "PaprWall ${{ needs.create-tag.outputs.tag_name }}"
          body: ${{ needs.create-tag.outputs.release_notes }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: false
          token: ${{ secrets.GITHUB_TOKEN }}

  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [check-version, create-tag, build-and-release]
    if: always() && needs.check-version.outputs.should_release == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update development files
        run: |
          VERSION="${{ needs.check-version.outputs.current_version }}"
          echo "Released version: $VERSION"

          # You could update changelog, bump dev version, etc. here
          echo "Post-release tasks completed"

      - name: Notify success
        if: needs.build-and-release.result == 'success'
        shell: bash
        run: |
          if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            {
              echo "## üéâ Release Successful!"
              echo ""
              echo "**Version**: ${{ needs.create-tag.outputs.tag_name }}"
              echo "**Release**: https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-tag.outputs.tag_name }}"
              echo ""
              echo "The release has been created and the CI workflow has been triggered to build and upload all platform-specific packages."
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## üéâ Release Successful!"
            echo "**Version**: ${{ needs.create-tag.outputs.tag_name }}"
            echo "**Release**: https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-tag.outputs.tag_name }}"
            echo "The release has been created and the CI workflow has been triggered to build and upload all platform-specific packages."
          fi

      - name: Notify failure
        if: needs.build-and-release.result == 'failure'
        shell: bash
        run: |
          if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            {
              echo "## ‚ùå Release Failed!"
              echo ""
              echo "**Version**: ${{ needs.create-tag.outputs.tag_name }}"
              echo "**Error**: Build and release process failed"
              echo ""
              echo "Please check the workflow logs and try again."
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## ‚ùå Release Failed!"
            echo "**Version**: ${{ needs.create-tag.outputs.tag_name }}"
            echo "**Error**: Build and release process failed"
            echo "Please check the workflow logs and try again."
          fi
          exit 1

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [check-version]
    if: always() && needs.check-version.outputs.should_release == 'false'

    steps:
      - name: No release needed
        shell: bash
        run: |
          if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            {
              echo "## ‚ÑπÔ∏è No Release Needed"
              echo ""
              echo "**Current Version**: ${{ needs.check-version.outputs.current_version }}"
              echo "**Reason**: Version unchanged since last commit"
              echo ""
              echo "To create a release:"
              echo "1. Update the version in \`src/paprwall/__version__.py\`"
              echo "2. Commit and push the changes"
              echo "3. Or use the manual 'workflow_dispatch' trigger"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## ‚ÑπÔ∏è No Release Needed"
            echo "**Current Version**: ${{ needs.check-version.outputs.current_version }}"
            echo "**Reason**: Version unchanged since last commit"
            echo "To create a release:"
            echo "1. Update the version in \`src/paprwall/__version__.py\`"
            echo "2. Commit and push the changes"
            echo "3. Or use the manual 'workflow_dispatch' trigger"
          fi
